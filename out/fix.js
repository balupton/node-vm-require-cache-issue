// Generated by CoffeeScript 1.3.3
(function() {
  var cache, coffee, data, dataFile, dataString, fsUtil, key, value, vm, _ref, _ref1,
    __hasProp = {}.hasOwnProperty;

  console.log("=== node vm require cache issue (with fix) ===");

  coffee = require('coffee-script');

  fsUtil = require('fs');

  vm = require('vm');

  dataFile = __dirname + '/../data.cson';

  dataString = fsUtil.readFileSync(dataFile).toString();

  cache = require.cache;

  _ref = require.cache;
  for (key in _ref) {
    if (!__hasProp.call(_ref, key)) continue;
    value = _ref[key];
    delete require.cache[key];
  }

  data = vm.runInNewContext("require('coffee-script').eval(dataString)", {
    require: require,
    dataString: dataString
  });

  for (key in cache) {
    if (!__hasProp.call(cache, key)) continue;
    value = cache[key];
    require.cache[key] = cache[key];
  }

  console.log('first pass:', data);

  dataString = fsUtil.readFileSync(dataFile).toString();

  cache = require.cache;

  _ref1 = require.cache;
  for (key in _ref1) {
    if (!__hasProp.call(_ref1, key)) continue;
    value = _ref1[key];
    delete require.cache[key];
  }

  data = vm.runInNewContext("require('coffee-script').eval(dataString)", {
    require: require,
    dataString: dataString
  });

  for (key in cache) {
    if (!__hasProp.call(cache, key)) continue;
    value = cache[key];
    require.cache[key] = cache[key];
  }

  console.log('second pass:', data);

  console.log('\n');

}).call(this);
